{% extends "layout.html" %}

{% block title %}{{ book.title }}{% endblock %}

{% block styles %}
<style>
    /* Reader specific styles */
    .reader-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
        font-size: var(--reader-font-size, 18px);
        font-family: 'Georgia', serif;
    }

    /* Font size customization */
    .font-size-sm { --reader-font-size: 16px; }
    .font-size-md { --reader-font-size: 18px; }
    .font-size-lg { --reader-font-size: 20px; }
    .font-size-xl { --reader-font-size: 22px; }

    /* Theme customization */
    .theme-light {
        --bg-color: #ffffff;
        --text-color: #333333;
    }
    .theme-sepia {
        --bg-color: #f5efdc;
        --text-color: #5b4636;
    }
    .theme-dark {
        --bg-color: #222222;
        --text-color: #dddddd;
    }

    .reader-body {
        background-color: var(--bg-color);
        color: var(--text-color);
        min-height: 100vh;
    }

    .reader-text {
        margin-bottom: 60px;
    }

    /* Interactive word styling */
    .word {
        cursor: pointer;
        border-radius: 3px;
        padding: 0 2px;
    }

    .word:hover {
        background-color: rgba(0, 123, 255, 0.1);
    }

    /* Modal styling */
    #wordInfoModal .modal-title {
        font-weight: bold;
    }

    #wordInfoModal .definition-section {
        border-left: 4px solid #007bff;
        padding-left: 15px;
        margin-bottom: 15px;
    }

    #wordInfoModal .example-section {
        font-style: italic;
        margin-bottom: 15px;
    }

    #wordInfoModal .grammar-section {
        background-color: rgba(0, 123, 255, 0.05);
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
    }

    #wordInfoModal .notes-section {
        font-size: 0.9em;
        color: #6c757d;
    }

    /* Controls bar */
    .reader-controls {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: var(--bg-color);
        padding: 10px 20px;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        z-index: 100;
    }

    /* Chat panel */
    .chat-panel {
        position: fixed;
        right: -350px;
        top: 0;
        bottom: 0;
        width: 350px;
        background-color: var(--bg-color);
        box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        transition: right 0.3s ease;
        z-index: 200;
        display: flex;
        flex-direction: column;
    }

    .chat-panel.open {
        right: 0;
    }

    .chat-header {
        padding: 15px;
        border-bottom: 1px solid rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
    }

    .chat-input {
        padding: 15px;
        border-top: 1px solid rgba(0,0,0,0.1);
    }

    .user-message {
        background-color: #e9ecef;
        color: #212529;
        border-radius: 15px 15px 0 15px;
        padding: 10px 15px;
        margin-bottom: 10px;
        max-width: 80%;
        align-self: flex-end;
        margin-left: auto;
    }

    .assistant-message {
        background-color: #007bff;
        color: white;
        border-radius: 15px 15px 15px 0;
        padding: 10px 15px;
        margin-bottom: 10px;
        max-width: 80%;
    }
    .reader-container {
    position: relative;
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
    background-color: var(--bg-color);
    min-height: 700px; /* Фиксированная минимальная высота для страниц */
    border-radius: 5px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .reader-text {
        line-height: 1.6;
        font-size: var(--reader-font-size, 18px);
        font-family: 'Georgia', serif;
        min-height: 600px; /* Минимальная высота для контента */
    }

    .pagination-controls {
        padding: 10px 0;
        margin-bottom: 20px;
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }

    .pagination-controls button {
        width: 40px;
        height: 40px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }

    .pagination-controls span {
        font-size: 0.95rem;
        color: var(--text-color);
    }

    /* Стили для предотвращения выделения текста при свайпе на мобильных устройствах */
    .reader-text {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    .word {
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
        user-select: text;
    }
    .page-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        z-index: 10;
        background-color: rgba(255, 255, 255, 0.8);
        padding: 20px;
        border-radius: 10px;
        display: none;
    }

    /* Стили для анимации перехода между страницами */
    .reader-text {
        transition: opacity 0.2s ease;
    }
    
    .reader-text.loading {
        opacity: 0.5;
    }
    .reader-container {
    position: relative;
    max-width: 800px;
    margin: 25px auto;
    padding: 20px;
    background-color: var(--bg-color);
   /* height: 75vh; /* Fixed height based on viewport */
    overflow: hidden; /* Hide overflow for page-flip effect */
    border-radius: 5px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.reader-text {
    line-height: 1.6;
    font-size: var(--reader-font-size, 18px);
    font-family: 'Georgia', serif;
    transition: opacity 0.3s ease;
}

.reader-text.loading {
    opacity: 0.5;
}
/* Temp container for measuring content */
.temp-measure-container {
    position: absolute;
    visibility: hidden;
    height: auto;
    width: auto;
    top: -9999px;
    left: -9999px;
}

/* Media queries for different screen sizes */
@media (max-height: 600px) {
    .reader-container {
        height: 65vh; /* Less height for smaller screens */
    }
}

@media (min-height: 1000px) {
    .reader-container {
        height: 80vh; /* More height for larger screens */
    }
}

/* Make sure pagination controls stay at the top */
.pagination-controls {
    padding: 10px 0;
    margin-bottom: 15px;
    border-bottom: 1px solid rgba(0,0,0,0.1);
}

/* Reader controls at bottom */
.reader-controls {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background-color: var(--bg-color);
    padding: 10px 20px;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    z-index: 100;
}
</style>
{% endblock %}

{% block body_class %}reader-body theme-light font-size-md{% endblock %}

{% block content %}
<!-- Top navigation bar for reader -->
<nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
    <div class="container-fluid">
        <a href="{{ url_for('book.library') }}" class="btn btn-outline-secondary me-3">
            <i class="fas fa-arrow-left"></i>
        </a>
        <span class="navbar-brand me-auto">{{ book.title }}</span>
        <div class="d-flex">
            <button class="btn btn-outline-secondary me-2" id="toggleSettings">
                <i class="fas fa-cog"></i>
            </button>
            <button class="btn btn-outline-primary" id="toggleChat">
                <i class="fas fa-comments"></i>
            </button>
        </div>
    </div>
</nav>

<!-- Main reading area -->
<div class="reader-container">
    <div class="reader-text">
        {{ formatted_text|safe }}
    </div>
</div>

<!-- Bottom control bar -->
<div class="reader-controls">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-4">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-secondary" id="decreaseFontSize">
                        <i class="fas fa-font fa-sm"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="increaseFontSize">
                        <i class="fas fa-font fa-lg"></i>
                    </button>
                </div>
                <div class="btn-group ms-2" role="group">
                    <button type="button" class="btn btn-outline-secondary" id="themeLight" title="Light theme">
                        <i class="fas fa-sun"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="themeSepia" title="Sepia theme">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="themeDark" title="Dark theme">
                        <i class="fas fa-star"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-4 text-center">
                <small class="text-muted">
                    {{ _('Reading') }} {{ book.title }} | {{ book.progress }}% {{ _('complete') }}
                </small>
            </div>
            <div class="col-md-4 text-end">
                <form action="{{ url_for('reader.end_session') }}" method="POST" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="book_id" value="{{ book.id }}">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="fas fa-bookmark me-1"></i> {{ _('Save & Exit') }}
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Word Information Modal -->
<div class="modal fade" id="wordInfoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="wordTitle">Word</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="wordLoading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">{{ _('Loading word information...') }}</p>
                </div>
                <div id="wordContent" class="d-none">
                    <div class="definition-section" id="definitionSection"></div>
                    <div class="grammar-section" id="grammarSection"></div>
                    <div class="example-section" id="exampleSection"></div>
                    <div class="notes-section" id="notesSection"></div>
                </div>
                <div id="wordError" class="alert alert-danger d-none">
                    {{ _('Error loading word information. Please try again.') }}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" id="askQuestionBtn">
                    <i class="fas fa-question-circle me-1"></i> {{ _('Ask a Question') }}
                </button>
                <button type="button" class="btn btn-outline-success" id="saveWordBtn">
                    <i class="fas fa-bookmark me-1"></i> {{ _('Save to Vocabulary') }}
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Close') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- Chat Panel -->
<div class="chat-panel" id="chatPanel">
    <div class="chat-header">
        <h5 class="mb-0">{{ _('Language Assistant') }}</h5>
        <button type="button" class="btn-close" id="closeChat"></button>
    </div>
    <div class="chat-messages" id="chatMessages">
        <div class="assistant-message">
            {{ _('Hello! I\'m your language assistant. How can I help you with') }} {{ book.language }}?
        </div>
    </div>
    <div class="chat-input">
        <div class="input-group">
            <input type="text" class="form-control" id="chatInput" placeholder="{{ _('Type your message...') }}">
            <button class="btn btn-primary" id="sendMessage">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
        <div class="d-flex justify-content-between mt-2">
            <button class="btn btn-sm btn-outline-secondary" id="clearChat">
                <i class="fas fa-trash-alt me-1"></i> {{ _('Clear Chat') }}
            </button>
            <button class="btn btn-sm btn-outline-primary" id="translateWord" disabled>
                <i class="fas fa-language me-1"></i> {{ _('Translate Current Word') }}
            </button>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('Reader Settings') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="readerSettingsForm">
                    <div class="mb-3">
                        <label for="fontSizeRange" class="form-label">{{ _('Font Size') }}</label>
                        <input type="range" class="form-range" min="1" max="4" step="1" value="2" id="fontSizeRange">
                        <div class="d-flex justify-content-between">
                            <span>{{ _('Small') }}</span>
                            <span>{{ _('Large') }}</span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">{{ _('Theme') }}</label>
                        <div class="d-flex justify-content-between">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="theme" id="themeRadioLight" value="light" checked>
                                <label class="form-check-label" for="themeRadioLight">
                                    {{ _('Light') }}
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="theme" id="themeRadioSepia" value="sepia">
                                <label class="form-check-label" for="themeRadioSepia">
                                    {{ _('Sepia') }}
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="theme" id="themeRadioDark" value="dark">
                                <label class="form-check-label" for="themeRadioDark">
                                    {{ _('Dark') }}
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">{{ _('Language Settings') }}</label>
                        <div class="row">
                            <div class="col-md-6">
                                <select class="form-select" id="sourceLanguage">
                                    <option value="en" {% if source_language == 'en' %}selected{% endif %}>{{ _('English') }}</option>
                                    <option value="de" {% if source_language == 'de' %}selected{% endif %}>{{ _('German') }}</option>
                                    <option value="fr" {% if source_language == 'fr' %}selected{% endif %}>{{ _('French') }}</option>
                                    <option value="es" {% if source_language == 'es' %}selected{% endif %}>{{ _('Spanish') }}</option>
                                    <option value="it" {% if source_language == 'it' %}selected{% endif %}>{{ _('Italian') }}</option>
                                    <option value="pl" {% if source_language == 'pl' %}selected{% endif %}>{{ _('Polish') }}</option>
                                    <option value="ru" {% if source_language == 'ru' %}selected{% endif %}>{{ _('Russian') }}</option>
                                </select>
                                <small class="form-text text-muted">{{ _('Book language') }}</small>
                            </div>
                            <div class="col-md-6">
                                <select class="form-select" id="targetLanguage">
                                    <option value="en" {% if target_language == 'en' %}selected{% endif %}>{{ _('English') }}</option>
                                    <option value="de" {% if target_language == 'de' %}selected{% endif %}>{{ _('German') }}</option>
                                    <option value="fr" {% if target_language == 'fr' %}selected{% endif %}>{{ _('French') }}</option>
                                    <option value="es" {% if target_language == 'es' %}selected{% endif %}>{{ _('Spanish') }}</option>
                                    <option value="it" {% if target_language == 'it' %}selected{% endif %}>{{ _('Italian') }}</option>
                                    <option value="pl" {% if target_language == 'pl' %}selected{% endif %}>{{ _('Polish') }}</option>
                                    <option value="ru" {% if target_language == 'ru' %}selected{% endif %}>{{ _('Russian') }}</option>
                                </select>
                                <small class="form-text text-muted">{{ _('Your language') }}</small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                <button type="button" class="btn btn-primary" id="saveSettings">{{ _('Save Settings') }}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Current word being viewed
        let currentWord = null;
        let currentWordContext = null;

        // Language settings
        let sourceLanguage = '{{ source_language }}';
        let targetLanguage = '{{ target_language }}';

        // Word click handler
        $('.word').on('click', function() {
            const word = $(this).data('word');
            currentWord = word;

            // Get surrounding context (approximately 10 words before and after)
            const wordElements = $('.word');
            const currentIndex = wordElements.index(this);
            const startIndex = Math.max(0, currentIndex - 10);
            const endIndex = Math.min(wordElements.length - 1, currentIndex + 10);

            let contextWords = [];
            for (let i = startIndex; i <= endIndex; i++) {
                const element = wordElements[i];
                if (i === currentIndex) {
                    contextWords.push('<strong>' + $(element).text() + '</strong>');
                } else {
                    contextWords.push($(element).text());
                }
            }

            currentWordContext = contextWords.join(' ');

            // Update modal and show it
            $('#wordTitle').text(word);
            $('#wordLoading').removeClass('d-none');
            $('#wordContent').addClass('d-none');
            $('#wordError').addClass('d-none');

            const modal = new bootstrap.Modal(document.getElementById('wordInfoModal'));
            modal.show();

            // Enable translate button in chat
            $('#translateWord').prop('disabled', false);

            // Fetch word information
            fetchWordInfo(word);
        });

        // Fetch word information from API
        function fetchWordInfo(word) {
            $.ajax({
                url: '{{ url_for("api.get_word_info") }}',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    word: word,
                    context: currentWordContext,
                    book_id: {{ book.id }},
                    source_language: sourceLanguage,
                    target_language: targetLanguage
                }),
                success: function(response) {
                    displayWordInfo(response);
                },
                error: function() {
                    $('#wordLoading').addClass('d-none');
                    $('#wordError').removeClass('d-none');
                }
            });
        }

        // Display word information in modal
        function displayWordInfo(data) {
            $('#wordLoading').addClass('d-none');

            if (data.error) {
                $('#wordError').removeClass('d-none').text(data.error);
                return;
            }

            // Simple formatting for demonstration - in a real app, you'd parse the AI response
            // more intelligently based on its structure
            $('#definitionSection').html(data.info);

            // Update save button based on whether word is in vocabulary
            if (data.in_vocabulary) {
                $('#saveWordBtn').html('<i class="fas fa-check me-1"></i> {{ _("In Vocabulary") }}');
                $('#saveWordBtn').removeClass('btn-outline-success').addClass('btn-success');
            } else {
                $('#saveWordBtn').html('<i class="fas fa-bookmark me-1"></i> {{ _("Save to Vocabulary") }}');
                $('#saveWordBtn').removeClass('btn-success').addClass('btn-outline-success');
            }

            $('#wordContent').removeClass('d-none');
        }

        // Save word to vocabulary
        $('#saveWordBtn').on('click', function() {
            if (!currentWord) return;

            $.ajax({
                url: '{{ url_for("api.add_to_vocabulary") }}',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    word: currentWord,
                    context: currentWordContext,
                    book_id: {{ book.id }}
                }),
                success: function(response) {
                    // Update button appearance
                    $('#saveWordBtn').html('<i class="fas fa-check me-1"></i> {{ _("In Vocabulary") }}');
                    $('#saveWordBtn').removeClass('btn-outline-success').addClass('btn-success');

                    // Show confirmation toast
                    showToast('{{ _("Word saved to vocabulary") }}');
                },
                error: function() {
                    showToast('{{ _("Error saving word") }}', 'error');
                }
            });
        });

        // Ask question button
        $('#askQuestionBtn').on('click', function() {
            if (!currentWord) return;

            // Hide the modal
            bootstrap.Modal.getInstance(document.getElementById('wordInfoModal')).hide();

            // Open chat panel and pre-fill with question about the word
            $('#chatPanel').addClass('open');
            $('#chatInput').val('{{ _("Can you explain more about the word") }} "' + currentWord + '"?');
            $('#chatInput').focus();
        });

        // Toggle chat panel
        $('#toggleChat').on('click', function() {
            $('#chatPanel').toggleClass('open');
        });

        // Close chat panel
        $('#closeChat').on('click', function() {
            $('#chatPanel').removeClass('open');
        });

        // Send chat message
        $('#sendMessage').on('click', sendChatMessage);

        // Enter key in chat input
        $('#chatInput').on('keypress', function(e) {
            if (e.which === 13) {
                sendChatMessage();
            }
        });

        // Send message function
        function sendChatMessage() {
            const message = $('#chatInput').val().trim();
            if (!message) return;

            // Add user message to chat
            $('#chatMessages').append(`
                <div class="user-message">
                    ${message}
                </div>
            `);

            // Clear input
            $('#chatInput').val('');

            // Scroll to bottom
            $('#chatMessages').scrollTop($('#chatMessages')[0].scrollHeight);

            // Add loading indicator
            const loadingId = 'loading-' + Date.now();
            $('#chatMessages').append(`
                <div class="assistant-message" id="${loadingId}">
                    <div class="spinner-border spinner-border-sm text-light" role="status"></div>
                    <span class="ms-2">{{ _("Thinking...") }}</span>
                </div>
            `);

            // Scroll to bottom
            $('#chatMessages').scrollTop($('#chatMessages')[0].scrollHeight);

            // Send to API
            $.ajax({
                url: '{{ url_for("api.chat") }}',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    message: message
                }),
                success: function(response) {
                    // Remove loading message
                    $(`#${loadingId}`).remove();

                    // Add assistant response
                    $('#chatMessages').append(`
                        <div class="assistant-message">
                            ${response.response}
                        </div>
                    `);

                    // Scroll to bottom
                    $('#chatMessages').scrollTop($('#chatMessages')[0].scrollHeight);
                },
                error: function() {
                    // Remove loading message
                    $(`#${loadingId}`).remove();

                    // Add error message
                    $('#chatMessages').append(`
                        <div class="assistant-message">
                            {{ _("Sorry, I'm having trouble connecting to the language assistant. Please try again.") }}
                        </div>
                    `);

                    // Scroll to bottom
                    $('#chatMessages').scrollTop($('#chatMessages')[0].scrollHeight);
                }
            });
        }

        // Clear chat history
        $('#clearChat').on('click', function() {
            $.ajax({
                url: '{{ url_for("reader.clear_chat") }}',
                type: 'POST',
                success: function() {
                    // Clear chat messages except for the welcome message
                    $('#chatMessages').html(`
                        <div class="assistant-message">
                            {{ _('Hello! I\'m your language assistant. How can I help you with') }} {{ book.language }}?
                        </div>
                    `);
                }
            });
        });

        // Translate current word
        $('#translateWord').on('click', function() {
            if (!currentWord) return;

            $('#chatInput').val('{{ _("Translate") }} "' + currentWord + '" {{ _("from") }} ' +
                sourceLanguage + ' {{ _("to") }} ' + targetLanguage);
            sendChatMessage();
        });

        // Font size controls
        $('#decreaseFontSize').on('click', function() {
            const sizes = ['font-size-sm', 'font-size-md', 'font-size-lg', 'font-size-xl'];
            const body = $('body');

            for (let i = 0; i < sizes.length; i++) {
                if (body.hasClass(sizes[i]) && i > 0) {
                    body.removeClass(sizes[i]);
                    body.addClass(sizes[i-1]);
                    $('#fontSizeRange').val(i);
                    break;
                }
            }
        });

        $('#increaseFontSize').on('click', function() {
            const sizes = ['font-size-sm', 'font-size-md', 'font-size-lg', 'font-size-xl'];
            const body = $('body');

            for (let i = 0; i < sizes.length; i++) {
                if (body.hasClass(sizes[i]) && i < sizes.length - 1) {
                    body.removeClass(sizes[i]);
                    body.addClass(sizes[i+1]);
                    $('#fontSizeRange').val(i+2);
                    break;
                }
            }
        });

        // Theme controls
        $('#themeLight').on('click', function() {
            $('body').removeClass('theme-sepia theme-dark').addClass('theme-light');
            $('#themeRadioLight').prop('checked', true);
        });

        $('#themeSepia').on('click', function() {
            $('body').removeClass('theme-light theme-dark').addClass('theme-sepia');
            $('#themeRadioSepia').prop('checked', true);
        });

        $('#themeDark').on('click', function() {
            $('body').removeClass('theme-light theme-sepia').addClass('theme-dark');
            $('#themeRadioDark').prop('checked', true);
        });

        // Toggle settings modal
        $('#toggleSettings').on('click', function() {
            const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
            modal.show();
        });

        // Font size range input
        $('#fontSizeRange').on('input', function() {
            const sizes = ['font-size-sm', 'font-size-md', 'font-size-lg', 'font-size-xl'];
            const val = parseInt($(this).val());

            $('body').removeClass(sizes.join(' ')).addClass(sizes[val-1]);
        });

        // Theme radio buttons
        $('input[name="theme"]').on('change', function() {
            const theme = $(this).val();
            $('body').removeClass('theme-light theme-sepia theme-dark').addClass('theme-' + theme);
        });

        // Save settings
        $('#saveSettings').on('click', function() {
            sourceLanguage = $('#sourceLanguage').val();
            targetLanguage = $('#targetLanguage').val();

            // Hide modal
            bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();

            // Show confirmation
            showToast('{{ _("Settings saved") }}');
        });

        // Show toast message
        function showToast(message, type = 'success') {
            const toastId = 'toast-' + Date.now();
            const toastHTML = `
                <div id="${toastId}" class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'}" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;

            // Append toast to body
            $('body').append(toastHTML);

            // Initialize and show toast
            const toast = new bootstrap.Toast(document.getElementById(toastId), {
                delay: 3000
            });
            toast.show();

            // Remove from DOM after hidden
            $(`#${toastId}`).on('hidden.bs.toast', function() {
                $(this).remove();
            });
        }
    });
    function forcePagination() {
    console.log("Starting pagination with enhanced controls");

    // Полифилл для crypto.randomUUID
    if (typeof crypto !== 'undefined' && !crypto.randomUUID) {
        crypto.randomUUID = function() {
            // Простая функция для генерации UUID v4
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        };
    }

    // Get original text content
    const originalContent = $('.reader-text').html();
    if (!originalContent || originalContent.trim() === '') {
        console.error('No text content to paginate');
        return;
    }

    // Clear the text container
    $('.reader-text').empty();

    // Create a temporary container for measuring content height
    const $tempContainer = $('<div class="temp-measure-container"></div>');
    $tempContainer.css({
        'position': 'absolute',
        'visibility': 'hidden',
        'width': $('.reader-text').width() + 'px',
        'font-size': $('.reader-text').css('font-size'),
        'line-height': $('.reader-text').css('line-height'),
        'font-family': $('.reader-text').css('font-family')
    });
    $('body').append($tempContainer);

    // Get the target height for each page (25% of viewport height for long books)
    const bookLength = originalContent.length;
    const targetHeight = Math.floor(window.innerHeight * 0.25);
    console.log(`Book length: ${bookLength}, using height factor: 0.25`);
    console.log(`Target page height: ${targetHeight}px`);

    // Split text into paragraphs
    const paragraphs = originalContent.split(/<br\s*\/?>/i).filter(p => p.trim() !== '');

    // Arrays to store page content
    const pages = [];
    let currentPage = '';
    let currentPageHeight = 0;

    // Function to check if an HTML string has balanced tags
    function hasBalancedTags(htmlString) {
        const openTagCount = (htmlString.match(/</g) || []).length;
        const closeTagCount = (htmlString.match(/>/g) || []).length;
        return openTagCount === closeTagCount;
    }

    // Function to find a good split point that doesn't break HTML tags
    function findSafeSplitPoint(htmlString, approximatePoint) {
        // First try to find a good sentence end
        const searchRange = 200;
        const forwardText = htmlString.substring(approximatePoint, Math.min(htmlString.length, approximatePoint + searchRange));
        const forwardMatch = forwardText.match(/[.!?]\s/);

        if (forwardMatch) {
            const potentialSplit = approximatePoint + forwardMatch.index + 2;
            const textBeforeSplit = htmlString.substring(0, potentialSplit);
            if (hasBalancedTags(textBeforeSplit)) {
                return potentialSplit;
            }
        }

        // If we can't find a sentence end with balanced tags, find the last balanced tag position
        const textToCheck = htmlString.substring(0, approximatePoint + searchRange);
        let bestPosition = 0;

        for (let i = approximatePoint; i < Math.min(htmlString.length, approximatePoint + searchRange); i++) {
            const textSlice = htmlString.substring(0, i);
            if (hasBalancedTags(textSlice)) {
                bestPosition = i;
            }
        }

        return bestPosition > 0 ? bestPosition : approximatePoint;
    }

    // Simplify and just create small fixed-size pages
    const chunkSize = 9350; // Примерное число символов на страницу

    // Try using simpler approach first - fixed-size chunks with safe splits
    let currentPos = 0;
    const contentLength = originalContent.length;

    while (currentPos < contentLength) {
        // Calculate end position for this chunk
        let endPos = Math.min(currentPos + chunkSize, contentLength);

        // Don't break in the middle of an HTML tag
        if (endPos < contentLength) {
            // Look forward for the next >
            const nextCloseTag = originalContent.indexOf('>', endPos);
            // Look backward for the previous <
            const prevOpenTag = originalContent.lastIndexOf('<', endPos);

            // If we're inside a tag, move to the end of it
            if (prevOpenTag > originalContent.lastIndexOf('>', endPos) && nextCloseTag !== -1) {
                endPos = nextCloseTag + 1;
            }

            // Look for a sentence end
            const lookBack = Math.min(300, endPos - currentPos);
            const segment = originalContent.substring(endPos - lookBack, endPos);
            const sentenceEnd = segment.lastIndexOf('. ');

            if (sentenceEnd !== -1) {
                endPos = endPos - lookBack + sentenceEnd + 2; // +2 for '. '
            }
        }

        // Add this chunk as a page
        pages.push(originalContent.substring(currentPos, endPos));
        currentPos = endPos;
    }

    // Remove temporary container
    $tempContainer.remove();

    // Set total pages
    let totalPages = pages.length;
    console.log(`Final text division: ${totalPages} pages`);

    // Add CSS for pagination controls and overlays
    $('head').append(`
        <style>
            .bottom-pagination-controls {
                margin-top: 20px;
                border-top: 1px solid rgba(0,0,0,0.1);
                padding: 10px 0;
                text-align: center;
                margin-bottom: 0px; /* Добавляем отступ снизу, чтобы нижняя панель не перекрывала */
            }

            .reader-text {
                padding-bottom: 20px;
                margin-bottom: 0; /* Сбрасываем внешний нижний отступ */
            }

            .page-overlay {
                position: absolute;
                top: 0;
                height: 100%;
                width: 15%;
                z-index: 10;
                cursor: pointer;
                opacity: 0;
                transition: opacity 0.2s;
            }

            .page-overlay:hover {
                opacity: 0.1;
                background-color: rgba(0, 0, 0, 0.05);
            }

            .page-overlay-left {
                left: 0;
            }

            .page-overlay-right {
                right: 0;
            }

            /* Стили для кнопок пагинации */
            .pagination-controls button, .bottom-pagination-controls button {
                width: 40px;
                height: 40px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
            }

            .pagination-controls span, .bottom-pagination-controls span {
                font-size: 0.95rem;
                color: var(--text-color);
            }

            /* Улучшаем видимость кнопок пагинации */
            .bottom-pagination-controls {
                background-color: var(--bg-color);
            }
        </style>
    `);

    // Create pagination controls at the top
    $('.pagination-controls').remove();
    const paginationControls = `
        <div class="pagination-controls text-center mb-3">
            <button id="prev-page-top" class="btn btn-outline-secondary me-2" disabled>
                <i class="fas fa-chevron-left"></i>
            </button>
            <span class="page-info mx-2">
                1 / ${totalPages}
            </span>
            <button id="next-page-top" class="btn btn-outline-secondary ms-2" ${totalPages === 1 ? 'disabled' : ''}>
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    `;

    $('.reader-container').prepend(paginationControls);

    // Create pagination controls at the bottom - обратите внимание, что мы используем append, а не after
    const bottomPaginationControls = `
        <div class="bottom-pagination-controls">
            <button id="prev-page-bottom" class="btn btn-outline-secondary me-2" disabled>
                <i class="fas fa-chevron-left"></i>
            </button>
            <span class="page-info-bottom mx-2">
                1 / ${totalPages}
            </span>
            <button id="next-page-bottom" class="btn btn-outline-secondary ms-2" ${totalPages === 1 ? 'disabled' : ''}>
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    `;

    // Добавляем нижние кнопки пагинации ВНУТРЬ reader-container
    $('.reader-container').append(bottomPaginationControls);

    // Add click overlays for mouse navigation
    $('.reader-container').append(`
        <div class="page-overlay page-overlay-left"></div>
        <div class="page-overlay page-overlay-right"></div>
    `);

    // Variables for pagination
    let currentPageIndex = 0;

    // Function to show page - simplified to reduce dependencies
    function showPage(pageIndex) {
        if (pageIndex < 0 || pageIndex >= totalPages) return;

        try {
            // Add loading class
            $('.reader-text').addClass('loading');

            // Get page content
            const pageContent = pages[pageIndex];

            // Update UI (simplified)
            currentPageIndex = pageIndex;
            $('.reader-text').html(pageContent);
            $('.pagination-controls .page-info').text(`${pageIndex + 1} / ${totalPages}`);
            $('.bottom-pagination-controls .page-info-bottom').text(`${pageIndex + 1} / ${totalPages}`);

            // Update button states (top)
            $('#prev-page-top').prop('disabled', pageIndex === 0);
            $('#next-page-top').prop('disabled', pageIndex === totalPages - 1);

            // Update button states (bottom)
            $('#prev-page-bottom').prop('disabled', pageIndex === 0);
            $('#next-page-bottom').prop('disabled', pageIndex === totalPages - 1);

            // Rebind word click handlers
            try {
                bindWordClickHandler();
            } catch (e) {
                console.error("Error binding word handlers:", e);
            }

            // Remove loading class
            $('.reader-text').removeClass('loading');

            // Scroll to top of page for better reading experience
            $('.reader-container').scrollTop(0);
        } catch (error) {
            console.error("Error displaying page:", error);
            // Basic fallback
            $('.reader-text').html("Error displaying page. Please try refreshing.");
            $('.reader-text').removeClass('loading');
        }
    }

    // Bind handlers to top buttons
    $('#prev-page-top').off('click').on('click', function() {
        showPage(currentPageIndex - 1);
    });

    $('#next-page-top').off('click').on('click', function() {
        showPage(currentPageIndex + 1);
    });

    // Bind handlers to bottom buttons
    $('#prev-page-bottom').off('click').on('click', function() {
        showPage(currentPageIndex - 1);
    });

    $('#next-page-bottom').off('click').on('click', function() {
        showPage(currentPageIndex + 1);
    });

    let lastWheelTime = 0;

    $('.reader-container').off('wheel').on('wheel', function(e) {
        const now = Date.now();
        const timeSinceLastScroll = now - lastWheelTime;

        if (timeSinceLastScroll < 300) return;  // минимальная задержка между скроллами

        const direction = e.originalEvent.deltaY;

        if (direction > 0) {
            // Колесо вниз — следующая страница
            showPage(currentPageIndex + 1);
        } else if (direction < 0) {
            // Колесо вверх — предыдущая страница
            showPage(currentPageIndex - 1);
        }

        lastWheelTime = now;
        e.preventDefault();
    });



    // Keyboard navigation
    $(document).off('keydown.pagination').on('keydown.pagination', function(e) {
        if (e.key === 'ArrowLeft') {
            showPage(currentPageIndex - 1);
        } else if (e.key === 'ArrowRight') {
            showPage(currentPageIndex + 1);
        }
    });

    // Mouse wheel navigation - ИСПРАВЛЕННАЯ ЛОГИКА
    $('.reader-container').off('wheel').on('wheel', function(e) {
        // Detect if we're at the top or bottom of the container
        const container = $(this);
        const atTop = container.scrollTop() <= 0;
        const atBottom = container.scrollTop() + container.innerHeight() >= container[0].scrollHeight - 10;

        // Only navigate if we're at the edge and trying to scroll further
        if ((atTop && e.originalEvent.deltaY < 0) || (atBottom && e.originalEvent.deltaY > 0)) {
            // Determine direction
            if (e.originalEvent.deltaY < 0 && atTop) {
                // Скролл вверх когда мы уже вверху - идем на предыдущую страницу
                showPage(currentPageIndex - 1);
                e.preventDefault();
            } else if (e.originalEvent.deltaY > 0 && atBottom) {
                // Скролл вниз когда мы уже внизу - идем на следующую страницу
                showPage(currentPageIndex + 1);
                e.preventDefault();
            }
        }
    });

    // Swipe navigation
    let touchStartX = 0;
    $('.reader-container').off('touchstart').on('touchstart', function(e) {
        touchStartX = e.originalEvent.touches[0].clientX;
    });

    $('.reader-container').off('touchend').on('touchend', function(e) {
        const touchEndX = e.originalEvent.changedTouches[0].clientX;
        const diff = touchStartX - touchEndX;

        if (Math.abs(diff) > 50) {
            if (diff > 0) {
                // Swipe left - next page
                showPage(currentPageIndex + 1);
            } else {
                // Swipe right - previous page
                showPage(currentPageIndex - 1);
            }
        }
    });

    // Show first page
    showPage(0);
}

    // Функция для привязки обработчиков к словам (копия из основного скрипта)
    function bindWordClickHandler() {
        $('.word').off('click').on('click', function() {
            const word = $(this).data('word');
            currentWord = word;

            // Получаем окружающий контекст
            const wordElements = $('.word');
            const currentIndex = wordElements.index(this);
            const startIndex = Math.max(0, currentIndex - 10);
            const endIndex = Math.min(wordElements.length - 1, currentIndex + 10);

            let contextWords = [];
            for (let i = startIndex; i <= endIndex; i++) {
                const element = wordElements[i];
                if (i === currentIndex) {
                    contextWords.push('<strong>' + $(element).text() + '</strong>');
                } else {
                    contextWords.push($(element).text());
                }
            }

            currentWordContext = contextWords.join(' ');

            // Обновляем модальное окно и показываем его
            $('#wordTitle').text(word);
            $('#wordLoading').removeClass('d-none');
            $('#wordContent').addClass('d-none');
            $('#wordError').addClass('d-none');

            const modal = new bootstrap.Modal(document.getElementById('wordInfoModal'));
            modal.show();

            // Включаем кнопку перевода в чате
            $('#translateWord').prop('disabled', false);

            // Получаем информацию о слове
            fetchWordInfo(word);
        });
    }

    // Запускаем принудительное разбиение через 500 мс после загрузки страницы
    setTimeout(function() {
        forcePagination();
    }, 500);
</script>
{% endblock %}