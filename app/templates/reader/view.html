{% extends "layout.html" %}

{% block title %}{{ book.title }}{% endblock %}

{% block styles %}
<style>
    /* Reader specific styles */
    .reader-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
        font-size: var(--reader-font-size, 18px);
        font-family: 'Georgia', serif;
    }

    /* Font size customization */
    .font-size-sm { --reader-font-size: 16px; }
    .font-size-md { --reader-font-size: 18px; }
    .font-size-lg { --reader-font-size: 20px; }
    .font-size-xl { --reader-font-size: 22px; }

    /* Theme customization */
    .theme-light {
        --bg-color: #ffffff;
        --text-color: #333333;
    }
    .theme-sepia {
        --bg-color: #f5efdc;
        --text-color: #5b4636;
    }
    .theme-dark {
        --bg-color: #222222;
        --text-color: #dddddd;
    }

    .reader-body {
        background-color: var(--bg-color);
        color: var(--text-color);
        min-height: 100vh;
    }

    .reader-text {
        margin-bottom: 60px;
    }

    /* Interactive word styling */
    .word {
        cursor: pointer;
        border-radius: 3px;
        padding: 0 2px;
    }

    .word:hover {
        background-color: rgba(0, 123, 255, 0.1);
    }

    /* Modal styling */
    #wordInfoModal .modal-title {
        font-weight: bold;
    }

    #wordInfoModal .definition-section {
        border-left: 4px solid #007bff;
        padding-left: 15px;
        margin-bottom: 15px;
    }

    #wordInfoModal .example-section {
        font-style: italic;
        margin-bottom: 15px;
    }

    #wordInfoModal .grammar-section {
        background-color: rgba(0, 123, 255, 0.05);
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
    }

    #wordInfoModal .notes-section {
        font-size: 0.9em;
        color: #6c757d;
    }

    /* Controls bar */
    .reader-controls {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: var(--bg-color);
        padding: 10px 20px;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        z-index: 100;
    }

    /* Chat panel */
    .chat-panel {
        position: fixed;
        right: -350px;
        top: 0;
        bottom: 0;
        width: 350px;
        background-color: var(--bg-color);
        box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        transition: right 0.3s ease;
        z-index: 200;
        display: flex;
        flex-direction: column;
    }

    .chat-panel.open {
        right: 0;
    }

    .chat-header {
        padding: 15px;
        border-bottom: 1px solid rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
    }

    .chat-input {
        padding: 15px;
        border-top: 1px solid rgba(0,0,0,0.1);
    }

    .user-message {
        background-color: #e9ecef;
        color: #212529;
        border-radius: 15px 15px 0 15px;
        padding: 10px 15px;
        margin-bottom: 10px;
        max-width: 80%;
        align-self: flex-end;
        margin-left: auto;
    }

    .assistant-message {
        background-color: #007bff;
        color: white;
        border-radius: 15px 15px 15px 0;
        padding: 10px 15px;
        margin-bottom: 10px;
        max-width: 80%;
    }
</style>
{% endblock %}

{% block body_class %}reader-body theme-light font-size-md{% endblock %}

{% block content %}
<!-- Top navigation bar for reader -->
<nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
    <div class="container-fluid">
        <a href="{{ url_for('book.library') }}" class="btn btn-outline-secondary me-3">
            <i class="fas fa-arrow-left"></i>
        </a>
        <span class="navbar-brand me-auto">{{ book.title }}</span>
        <div class="d-flex">
            <button class="btn btn-outline-secondary me-2" id="toggleSettings">
                <i class="fas fa-cog"></i>
            </button>
            <button class="btn btn-outline-primary" id="toggleChat">
                <i class="fas fa-comments"></i>
            </button>
        </div>
    </div>
</nav>

<!-- Main reading area -->
<div class="reader-container">
    <div class="reader-text">
        {{ formatted_text|safe }}
    </div>
</div>

<!-- Bottom control bar -->
<div class="reader-controls">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-4">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-secondary" id="decreaseFontSize">
                        <i class="fas fa-font fa-sm"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="increaseFontSize">
                        <i class="fas fa-font fa-lg"></i>
                    </button>
                </div>
                <div class="btn-group ms-2" role="group">
                    <button type="button" class="btn btn-outline-secondary" id="themeLight" title="Light theme">
                        <i class="fas fa-sun"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="themeSepia" title="Sepia theme">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="themeDark" title="Dark theme">
                        <i class="fas fa-star"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-4 text-center">
                <small class="text-muted">
                    {{ _('Reading') }} {{ book.title }} | {{ book.progress }}% {{ _('complete') }}
                </small>
            </div>
            <div class="col-md-4 text-end">
                <form action="{{ url_for('reader.end_session') }}" method="POST" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="book_id" value="{{ book.id }}">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="fas fa-bookmark me-1"></i> {{ _('Save & Exit') }}
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Word Information Modal -->
<div class="modal fade" id="wordInfoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="wordTitle">Word</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="wordLoading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">{{ _('Loading word information...') }}</p>
                </div>
                <div id="wordContent" class="d-none">
                    <div class="definition-section" id="definitionSection"></div>
                    <div class="grammar-section" id="grammarSection"></div>
                    <div class="example-section" id="exampleSection"></div>
                    <div class="notes-section" id="notesSection"></div>
                </div>
                <div id="wordError" class="alert alert-danger d-none">
                    {{ _('Error loading word information. Please try again.') }}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" id="askQuestionBtn">
                    <i class="fas fa-question-circle me-1"></i> {{ _('Ask a Question') }}
                </button>
                <button type="button" class="btn btn-outline-success" id="saveWordBtn">
                    <i class="fas fa-bookmark me-1"></i> {{ _('Save to Vocabulary') }}
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Close') }}</button>
            </div>
        </div>
    </div>
</div>

<!-- Chat Panel -->
<div class="chat-panel" id="chatPanel">
    <div class="chat-header">
        <h5 class="mb-0">{{ _('Language Assistant') }}</h5>
        <button type="button" class="btn-close" id="closeChat"></button>
    </div>
    <div class="chat-messages" id="chatMessages">
        <div class="assistant-message">
            {{ _('Hello! I\'m your language assistant. How can I help you with') }} {{ book.language }}?
        </div>
    </div>
    <div class="chat-input">
        <div class="input-group">
            <input type="text" class="form-control" id="chatInput" placeholder="{{ _('Type your message...') }}">
            <button class="btn btn-primary" id="sendMessage">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
        <div class="d-flex justify-content-between mt-2">
            <button class="btn btn-sm btn-outline-secondary" id="clearChat">
                <i class="fas fa-trash-alt me-1"></i> {{ _('Clear Chat') }}
            </button>
            <button class="btn btn-sm btn-outline-primary" id="translateWord" disabled>
                <i class="fas fa-language me-1"></i> {{ _('Translate Current Word') }}
            </button>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('Reader Settings') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="readerSettingsForm">
                    <div class="mb-3">
                        <label for="fontSizeRange" class="form-label">{{ _('Font Size') }}</label>
                        <input type="range" class="form-range" min="1" max="4" step="1" value="2" id="fontSizeRange">
                        <div class="d-flex justify-content-between">
                            <span>{{ _('Small') }}</span>
                            <span>{{ _('Large') }}</span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">{{ _('Theme') }}</label>
                        <div class="d-flex justify-content-between">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="theme" id="themeRadioLight" value="light" checked>
                                <label class="form-check-label" for="themeRadioLight">
                                    {{ _('Light') }}
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="theme" id="themeRadioSepia" value="sepia">
                                <label class="form-check-label" for="themeRadioSepia">
                                    {{ _('Sepia') }}
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="theme" id="themeRadioDark" value="dark">
                                <label class="form-check-label" for="themeRadioDark">
                                    {{ _('Dark') }}
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">{{ _('Language Settings') }}</label>
                        <div class="row">
                            <div class="col-md-6">
                                <select class="form-select" id="sourceLanguage">
                                    <option value="en" {% if source_language == 'en' %}selected{% endif %}>{{ _('English') }}</option>
                                    <option value="de" {% if source_language == 'de' %}selected{% endif %}>{{ _('German') }}</option>
                                    <option value="fr" {% if source_language == 'fr' %}selected{% endif %}>{{ _('French') }}</option>
                                    <option value="es" {% if source_language == 'es' %}selected{% endif %}>{{ _('Spanish') }}</option>
                                    <option value="it" {% if source_language == 'it' %}selected{% endif %}>{{ _('Italian') }}</option>
                                    <option value="pl" {% if source_language == 'pl' %}selected{% endif %}>{{ _('Polish') }}</option>
                                    <option value="ru" {% if source_language == 'ru' %}selected{% endif %}>{{ _('Russian') }}</option>
                                </select>
                                <small class="form-text text-muted">{{ _('Book language') }}</small>
                            </div>
                            <div class="col-md-6">
                                <select class="form-select" id="targetLanguage">
                                    <option value="en" {% if target_language == 'en' %}selected{% endif %}>{{ _('English') }}</option>
                                    <option value="de" {% if target_language == 'de' %}selected{% endif %}>{{ _('German') }}</option>
                                    <option value="fr" {% if target_language == 'fr' %}selected{% endif %}>{{ _('French') }}</option>
                                    <option value="es" {% if target_language == 'es' %}selected{% endif %}>{{ _('Spanish') }}</option>
                                    <option value="it" {% if target_language == 'it' %}selected{% endif %}>{{ _('Italian') }}</option>
                                    <option value="pl" {% if target_language == 'pl' %}selected{% endif %}>{{ _('Polish') }}</option>
                                    <option value="ru" {% if target_language == 'ru' %}selected{% endif %}>{{ _('Russian') }}</option>
                                </select>
                                <small class="form-text text-muted">{{ _('Your language') }}</small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
                <button type="button" class="btn btn-primary" id="saveSettings">{{ _('Save Settings') }}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/reader.js') }}"></script>
<script>
    $(document).ready(function() {
        // Current word being viewed
        let currentWord = null;
        let currentWordContext = null;

        // Language settings
        let sourceLanguage = '{{ source_language }}';
        let targetLanguage = '{{ target_language }}';

        // Word click handler
        $('.word').on('click', function() {
            const word = $(this).data('word');
            currentWord = word;

            // Get surrounding context (approximately 10 words before and after)
            const wordElements = $('.word');
            const currentIndex = wordElements.index(this);
            const startIndex = Math.max(0, currentIndex - 10);
            const endIndex = Math.min(wordElements.length - 1, currentIndex + 10);

            let contextWords = [];
            for (let i = startIndex; i <= endIndex; i++) {
                const element = wordElements[i];
                if (i === currentIndex) {
                    contextWords.push('<strong>' + $(element).text() + '</strong>');
                } else {
                    contextWords.push($(element).text());
                }
            }

            currentWordContext = contextWords.join(' ');

            // Update modal and show it
            $('#wordTitle').text(word);
            $('#wordLoading').removeClass('d-none');
            $('#wordContent').addClass('d-none');
            $('#wordError').addClass('d-none');

            const modal = new bootstrap.Modal(document.getElementById('wordInfoModal'));
            modal.show();

            // Enable translate button in chat
            $('#translateWord').prop('disabled', false);

            // Fetch word information
            fetchWordInfo(word);
        });

        // Fetch word information from API
        function fetchWordInfo(word) {
            $.ajax({
                url: '{{ url_for("api.get_word_info") }}',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    word: word,
                    context: currentWordContext,
                    book_id: {{ book.id }},
                    source_language: sourceLanguage,
                    target_language: targetLanguage
                }),
                success: function(response) {
                    displayWordInfo(response);
                },
                error: function() {
                    $('#wordLoading').addClass('d-none');
                    $('#wordError').removeClass('d-none');
                }
            });
        }

        // Display word information in modal
        function displayWordInfo(data) {
            $('#wordLoading').addClass('d-none');

            if (data.error) {
                $('#wordError').removeClass('d-none').text(data.error);
                return;
            }

            // Simple formatting for demonstration - in a real app, you'd parse the AI response
            // more intelligently based on its structure
            $('#definitionSection').html(data.info);

            // Update save button based on whether word is in vocabulary
            if (data.in_vocabulary) {
                $('#saveWordBtn').html('<i class="fas fa-check me-1"></i> {{ _("In Vocabulary") }}');
                $('#saveWordBtn').removeClass('btn-outline-success').addClass('btn-success');
            } else {
                $('#saveWordBtn').html('<i class="fas fa-bookmark me-1"></i> {{ _("Save to Vocabulary") }}');
                $('#saveWordBtn').removeClass('btn-success').addClass('btn-outline-success');
            }

            $('#wordContent').removeClass('d-none');
        }

        // Save word to vocabulary
        $('#saveWordBtn').on('click', function() {
            if (!currentWord) return;

            $.ajax({
                url: '{{ url_for("api.add_to_vocabulary") }}',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    word: currentWord,
                    context: currentWordContext,
                    book_id: {{ book.id }}
                }),
                success: function(response) {
                    // Update button appearance
                    $('#saveWordBtn').html('<i class="fas fa-check me-1"></i> {{ _("In Vocabulary") }}');
                    $('#saveWordBtn').removeClass('btn-outline-success').addClass('btn-success');

                    // Show confirmation toast
                    showToast('{{ _("Word saved to vocabulary") }}');
                },
                error: function() {
                    showToast('{{ _("Error saving word") }}', 'error');
                }
            });
        });

        // Ask question button
        $('#askQuestionBtn').on('click', function() {
            if (!currentWord) return;

            // Hide the modal
            bootstrap.Modal.getInstance(document.getElementById('wordInfoModal')).hide();

            // Open chat panel and pre-fill with question about the word
            $('#chatPanel').addClass('open');
            $('#chatInput').val('{{ _("Can you explain more about the word") }} "' + currentWord + '"?');
            $('#chatInput').focus();
        });

        // Toggle chat panel
        $('#toggleChat').on('click', function() {
            $('#chatPanel').toggleClass('open');
        });

        // Close chat panel
        $('#closeChat').on('click', function() {
            $('#chatPanel').removeClass('open');
        });

        // Send chat message
        $('#sendMessage').on('click', sendChatMessage);

        // Enter key in chat input
        $('#chatInput').on('keypress', function(e) {
            if (e.which === 13) {
                sendChatMessage();
            }
        });

        // Send message function
        function sendChatMessage() {
            const message = $('#chatInput').val().trim();
            if (!message) return;

            // Add user message to chat
            $('#chatMessages').append(`
                <div class="user-message">
                    ${message}
                </div>
            `);

            // Clear input
            $('#chatInput').val('');

            // Scroll to bottom
            $('#chatMessages').scrollTop($('#chatMessages')[0].scrollHeight);

            // Add loading indicator
            const loadingId = 'loading-' + Date.now();
            $('#chatMessages').append(`
                <div class="assistant-message" id="${loadingId}">
                    <div class="spinner-border spinner-border-sm text-light" role="status"></div>
                    <span class="ms-2">{{ _("Thinking...") }}</span>
                </div>
            `);

            // Scroll to bottom
            $('#chatMessages').scrollTop($('#chatMessages')[0].scrollHeight);

            // Send to API
            $.ajax({
                url: '{{ url_for("api.chat") }}',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    message: message
                }),
                success: function(response) {
                    // Remove loading message
                    $(`#${loadingId}`).remove();

                    // Add assistant response
                    $('#chatMessages').append(`
                        <div class="assistant-message">
                            ${response.response}
                        </div>
                    `);

                    // Scroll to bottom
                    $('#chatMessages').scrollTop($('#chatMessages')[0].scrollHeight);
                },
                error: function() {
                    // Remove loading message
                    $(`#${loadingId}`).remove();

                    // Add error message
                    $('#chatMessages').append(`
                        <div class="assistant-message">
                            {{ _("Sorry, I'm having trouble connecting to the language assistant. Please try again.") }}
                        </div>
                    `);

                    // Scroll to bottom
                    $('#chatMessages').scrollTop($('#chatMessages')[0].scrollHeight);
                }
            });
        }

        // Clear chat history
        $('#clearChat').on('click', function() {
            $.ajax({
                url: '{{ url_for("reader.clear_chat") }}',
                type: 'POST',
                success: function() {
                    // Clear chat messages except for the welcome message
                    $('#chatMessages').html(`
                        <div class="assistant-message">
                            {{ _('Hello! I\'m your language assistant. How can I help you with') }} {{ book.language }}?
                        </div>
                    `);
                }
            });
        });

        // Translate current word
        $('#translateWord').on('click', function() {
            if (!currentWord) return;

            $('#chatInput').val('{{ _("Translate") }} "' + currentWord + '" {{ _("from") }} ' +
                sourceLanguage + ' {{ _("to") }} ' + targetLanguage);
            sendChatMessage();
        });

        // Font size controls
        $('#decreaseFontSize').on('click', function() {
            const sizes = ['font-size-sm', 'font-size-md', 'font-size-lg', 'font-size-xl'];
            const body = $('body');

            for (let i = 0; i < sizes.length; i++) {
                if (body.hasClass(sizes[i]) && i > 0) {
                    body.removeClass(sizes[i]);
                    body.addClass(sizes[i-1]);
                    $('#fontSizeRange').val(i);
                    break;
                }
            }
        });

        $('#increaseFontSize').on('click', function() {
            const sizes = ['font-size-sm', 'font-size-md', 'font-size-lg', 'font-size-xl'];
            const body = $('body');

            for (let i = 0; i < sizes.length; i++) {
                if (body.hasClass(sizes[i]) && i < sizes.length - 1) {
                    body.removeClass(sizes[i]);
                    body.addClass(sizes[i+1]);
                    $('#fontSizeRange').val(i+2);
                    break;
                }
            }
        });

        // Theme controls
        $('#themeLight').on('click', function() {
            $('body').removeClass('theme-sepia theme-dark').addClass('theme-light');
            $('#themeRadioLight').prop('checked', true);
        });

        $('#themeSepia').on('click', function() {
            $('body').removeClass('theme-light theme-dark').addClass('theme-sepia');
            $('#themeRadioSepia').prop('checked', true);
        });

        $('#themeDark').on('click', function() {
            $('body').removeClass('theme-light theme-sepia').addClass('theme-dark');
            $('#themeRadioDark').prop('checked', true);
        });

        // Toggle settings modal
        $('#toggleSettings').on('click', function() {
            const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
            modal.show();
        });

        // Font size range input
        $('#fontSizeRange').on('input', function() {
            const sizes = ['font-size-sm', 'font-size-md', 'font-size-lg', 'font-size-xl'];
            const val = parseInt($(this).val());

            $('body').removeClass(sizes.join(' ')).addClass(sizes[val-1]);
        });

        // Theme radio buttons
        $('input[name="theme"]').on('change', function() {
            const theme = $(this).val();
            $('body').removeClass('theme-light theme-sepia theme-dark').addClass('theme-' + theme);
        });

        // Save settings
        $('#saveSettings').on('click', function() {
            sourceLanguage = $('#sourceLanguage').val();
            targetLanguage = $('#targetLanguage').val();

            // Hide modal
            bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();

            // Show confirmation
            showToast('{{ _("Settings saved") }}');
        });

        // Show toast message
        function showToast(message, type = 'success') {
            const toastId = 'toast-' + Date.now();
            const toastHTML = `
                <div id="${toastId}" class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'}" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;

            // Append toast to body
            $('body').append(toastHTML);

            // Initialize and show toast
            const toast = new bootstrap.Toast(document.getElementById(toastId), {
                delay: 3000
            });
            toast.show();

            // Remove from DOM after hidden
            $(`#${toastId}`).on('hidden.bs.toast', function() {
                $(this).remove();
            });
        }
    });
</script>
{% endblock %}